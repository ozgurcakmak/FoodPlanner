<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Food Looper</title>
    <style>
        :root { --bg: #fdf6e3; --fg: #586e75; --accent: #cb4b16; --card: #eee8d5; --green: #859900; }
        body { background: var(--bg); color: var(--fg); font-family: 'Segoe UI', sans-serif; padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px;}
        h2 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; font-size: 1.2rem; text-transform: uppercase; color: var(--accent); }
        
        /* Inputs & Buttons */
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input, select { background: #fff; border: 1px solid #ccc; color: #333; padding: 12px; border-radius: 6px; font-size: 16px; }
        input:focus { outline: 2px solid var(--accent); }
        .flex-grow { flex-grow: 1; }
        button { background: var(--accent); color: #fff; border: none; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; }
        button.secondary { background: #93a1a1; color: #fff; }

        /* Food List */
        .food-card { background: #fff; padding: 15px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .food-card.essential { border-left-color: var(--green); } /* Green for Essential */
        .food-card.optional { border-left-color: #268bd2; } /* Blue for Optional */
        .meta { font-size: 0.8rem; color: #999; margin-top: 4px; }
        .delete-btn { color: #dc322f; cursor: pointer; padding: 5px 10px; font-size: 1.2rem; font-weight: bold; }

        /* Sync Status */
        #sync-status { font-size: 0.8rem; text-align: right; margin-bottom: 10px; color: #999; }
        .settings-panel { background: #eee8d5; padding: 15px; border-radius: 8px; border: 1px solid #d3d3d3; margin-bottom: 20px; display: none; }
        
        /* Result Area */
        #result-area { margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .total-badge { background: var(--green); color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="border:none; margin:0;">Food Looper</h2>
        <button class="secondary" onclick="toggleSettings()" style="padding: 5px 10px; font-size: 0.8rem;">‚öôÔ∏è Sync</button>
    </div>
    <div id="sync-status">Local Mode</div>

    <div id="settings" class="settings-panel">
        <p style="margin-top:0; font-size:0.9rem; color:#666;">JSONBin.io Config (Cloud Save)</p>
        <input type="text" id="binId" placeholder="Bin ID (e.g. 65c3...)" style="width:100%; box-sizing:border-box; margin-bottom:10px;">
        <input type="password" id="apiKey" placeholder="X-Master-Key ($2a$10...)" style="width:100%; box-sizing:border-box; margin-bottom:10px;">
        <div style="display:flex; gap:10px;">
            <button onclick="saveSettings()" class="flex-grow">Save & Connect</button>
            <button onclick="pullFromCloud()" class="secondary">Force Pull</button>
        </div>
    </div>

    <div class="input-group">
        <input type="text" id="foodName" class="flex-grow" placeholder="Food Name (e.g. Greek Salad)">
        <input type="number" id="foodCals" placeholder="Kcal" style="width: 60px;">
    </div>
    <div class="input-group">
        <select id="foodType" class="flex-grow">
            <option value="essential">ü•¶ Essential (Must Eat)</option>
            <option value="optional">üç© Cravings (Random)</option>
        </select>
        <button onclick="addFood()">Add</button>
    </div>
    
    <div id="config-list"></div>

    <div id="result-area">
        <h3 style="margin-top:0; color:var(--accent)">Daily Generator</h3>
        <div class="input-group">
            <input type="number" id="dailyLimit" class="flex-grow" placeholder="Daily Calorie Limit (e.g. 2000)">
            <button onclick="generate()">Cook</button>
        </div>
        <div id="output"></div>
    </div>

<script>
    // STATE
    let foods = [];
    let binId = localStorage.getItem('flooper_binId') || '';
    let apiKey = localStorage.getItem('flooper_apiKey') || '';

    // INIT
    if (binId && apiKey) {
        document.getElementById('binId').value = binId;
        document.getElementById('apiKey').value = apiKey;
        pullFromCloud(); 
    } else {
        loadLocal();
    }

    // --- CORE LOGIC ---
    
    function addFood() {
        const name = document.getElementById('foodName').value;
        const cals = parseInt(document.getElementById('foodCals').value) || 0;
        const type = document.getElementById('foodType').value;
        if (!name) return;
        
        foods.push({ name, cals, type });
        document.getElementById('foodName').value = '';
        document.getElementById('foodCals').value = '';
        render();
        saveData();
    }

    function removeFood(idx) {
        foods.splice(idx, 1);
        render();
        saveData();
    }

    function generate() {
        const limit = parseInt(document.getElementById('dailyLimit').value) || 2000;
        const output = document.getElementById('output');
        
        let total = 0;
        let menu = [];

        // 1. Mandatory Essentials
        const essentials = foods.filter(f => f.type === 'essential');
        essentials.forEach(f => { menu.push(f); total += f.cals; });

        // 2. Random Cravings
        let cravings = foods.filter(f => f.type === 'optional');
        // Shuffle
        for (let i = cravings.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cravings[i], cravings[j]] = [cravings[j], cravings[i]];
        }

        // Fill remaining calories
        for (let f of cravings) {
            if (total + f.cals <= limit) {
                menu.push(f);
                total += f.cals;
            }
        }

        output.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background: #fff; padding:10px; border-radius:6px;">
                <span class="total-badge">${total} / ${limit} Kcal</span>
                <span style="font-size:0.8rem; color:#888;">${menu.length} Items</span>
            </div>
            ${menu.map(f => `
                <div class="food-card ${f.type}">
                    <div>
                        <strong>${f.name}</strong>
                        <div class="meta">${f.cals} Kcal | ${f.type === 'essential' ? 'ESSENTIAL' : 'CRAVING'}</div>
                    </div>
                </div>
            `).join('')}
        `;
    }

    function render() {
        const list = document.getElementById('config-list');
        list.innerHTML = foods.map((f, i) => `
            <div class="food-card ${f.type}">
                <div>
                    <strong>${f.name}</strong>
                    <div class="meta">${f.cals} Kcal | ${f.type === 'essential' ? 'Essential' : 'Craving'}</div>
                </div>
                <div class="delete-btn" onclick="removeFood(${i})">√ó</div>
            </div>
        `).join('');
    }

    // --- SYNC & STORAGE ---

    function toggleSettings() {
        const el = document.getElementById('settings');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function saveSettings() {
        binId = document.getElementById('binId').value;
        apiKey = document.getElementById('apiKey').value;
        localStorage.setItem('flooper_binId', binId);
        localStorage.setItem('flooper_apiKey', apiKey);
        pushToCloud();
        toggleSettings();
    }

    function loadLocal() {
        const saved = localStorage.getItem('flooper_data');
        if (saved) foods = JSON.parse(saved);
        render();
    }

    async function pushToCloud() {
        updateStatus('Saving...');
        localStorage.setItem('flooper_data', JSON.stringify(foods));
        
        if (!binId || !apiKey) return;

        try {
            await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': apiKey },
                body: JSON.stringify({ foods: foods })
            });
            updateStatus('Synced (Cloud)');
        } catch (e) {
            updateStatus('Sync Error');
            console.error(e);
        }
    }

    async function pullFromCloud() {
        if (!binId || !apiKey) return;
        updateStatus('Pulling...');

        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                headers: { 'X-Master-Key': apiKey }
            });
            const data = await res.json();
            if (data.record && data.record.foods) {
                foods = data.record.foods;
                render();
                localStorage.setItem('flooper_data', JSON.stringify(foods));
                updateStatus('Synced (Cloud)');
            }
        } catch (e) {
            updateStatus('Sync Error (Using Local)');
            loadLocal();
        }
    }

    function saveData() { pushToCloud(); }

    function updateStatus(msg) {
        document.getElementById('sync-status').innerText = msg;
    }
</script>
</body>
</html>
